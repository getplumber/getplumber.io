---
/**
 * Analytics consent banner for GDPR/CNIL (France) compliance.
 * Plausible Analytics is loaded only after the user accepts; declining disables analytics.
 */

import Button from "@components/Button/Button.astro";
import { getLocaleFromUrl } from "@js/localeUtils";

const currLocale = getLocaleFromUrl(Astro.url);
---

<!-- Dialog API would be nice to use here. But Safari doesn't support it yet. https://caniuse.com/?search=dialog -->
<div id="accept-banner" class="fixed inset-x-6 bottom-6 z-50 hidden justify-center">
  <div
    class="border-base-400 bg-base-200 dark:border-base-600/60 dark:bg-base-800 flex flex-wrap items-center justify-center gap-x-6 gap-y-4 rounded-md border p-4"
  >
    <div class="text-center">
      <p class="text-sm lg:text-base">
        We use anonymous analytics to understand how the site is used. You can accept or refuse. See our
        <a
          href={"/privacy-policy"}
          aria-label="Privacy Policy"
          class="text-primary-600 hover:text-primary-800 dark:text-primary-300 dark:hover:text-primary-400 underline transition"
          >Privacy Policy</a
        >
        for details.
      </p>
    </div>
    <div class="mx-auto flex gap-2">
      <Button variant="primary" type="button">Accept</Button>
      <Button variant="ghost" type="button">Refuse</Button>
    </div>
  </div>
</div>

<script>
  // checks the "cookie-consent" cookie
  function getCookieConsent() {
    try {
      //@ts-ignore (it's in a try catch for a reason)
      const consent = document.cookie.match(/cookie-consent=([^;]+)/)[1];
      return consent;
    } catch (error) {
      return "unk";
    }
  }

  function cookieConsentSetup() {
    const cookieBanner = document.getElementById("accept-banner");
    const acceptButton = document.querySelector("#accept-banner button:first-of-type");
    const declineButton = document.querySelector("#accept-banner button:last-of-type");

    function setConsentCookie(value, maxAgeDays) {
      const d = new Date();
      d.setTime(d.getTime() + maxAgeDays * 24 * 60 * 60 * 1000);
      document.cookie = "cookie-consent=" + value + "; path=/; expires=" + d.toUTCString() + "; SameSite=Lax";
    }

    const cookieConsent = getCookieConsent();
    if (cookieConsent !== "accept" && cookieConsent !== "decline") {
      cookieBanner?.classList.add("flex");
      cookieBanner?.classList.remove("hidden");
    }

    acceptButton?.addEventListener("click", () => {
      cookieBanner?.classList.add("hidden");
      setConsentCookie("accept", 365);
      const enable = (window as Record<string, unknown>)["enablePlausibleAnalytics"];
      if (typeof enable === "function") (enable as () => void)();
    });

    declineButton?.addEventListener("click", () => {
      cookieBanner?.classList.add("hidden");
      setConsentCookie("decline", 365);
    });
  }

  // runs on initial page load
  cookieConsentSetup();

  // runs on view transitions navigation
  document.addEventListener("astro:after-swap", cookieConsentSetup);
</script>
