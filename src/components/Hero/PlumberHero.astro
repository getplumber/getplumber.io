---
import Button from "@components/Button/Button.astro";
import { getLocaleFromUrl } from "@js/localeUtils";
import { type CollectionEntry, getCollection, render } from "astro:content";
import { Icon } from "astro-icon/components";

const currLocale = getLocaleFromUrl(Astro.url);

// Get code toggle sections for Plumber (GitLab CI/CD and Local CLI)
const codeToggles = await getCollection("codeToggles", ({ data }) => {
  // Only get GitLab CI/CD and Local CLI toggles
  return data.draft !== true && (data.language === "GitLab CI/CD" || data.language === "Local CLI");
});

interface codeToggleDataProps {
  language: string;
  order: number;
  icon?: string;
  code: any; // return from render() function. This is the code HTML
  rawCode: string; // raw code text for copying
}

// for each element in codeToggles, render the code and return the data
const codeToggleData: codeToggleDataProps[] = await Promise.all(
  codeToggles.map(async (codeToggle) => {
    const { language, order, icon } = codeToggle.data;
    const { Content } = await render(codeToggle);
    
    // We'll extract raw code from the rendered HTML on the client side
    // For now, set empty string - will be populated by JavaScript
    const rawCode = '';
    
    return { language, order, icon, code: Content, rawCode };
  }),
);

// sort the elements by order
codeToggleData.sort((a, b) => a.order - b.order);
---

<section id="plumber-hero" class="relative flex w-full overflow-hidden pt-32 pb-16 md:pt-40 md:pb-24">
  <!-- background glow -->
  <div
    class="bg-primary-500/50 absolute inset-0 bottom-1/2 -z-10 mx-auto aspect-square w-[65%] max-w-5xl -translate-y-2/3 rounded-full blur-[100px]"
    aria-hidden="true"
  >
  </div>

  <!-- background grid svg -->
  <div class="absolute inset-0 -z-20 flex overflow-hidden">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="text-base-400/10 dark:text-base-500/5 relative h-full w-full xl:scale-125"
      aria-hidden="true"
    >
      <defs>
        <pattern id="grid-pattern" width="60" height="60" patternUnits="userSpaceOnUse">
          <path d="M 60 0 L 0 0 0 60" fill="none" stroke="currentColor" stroke-width="2"></path>
        </pattern>
      </defs>
      <rect width="100%" height="100%" fill="url(#grid-pattern)"></rect>
    </svg>
  </div>

  <!-- hero items -->
  <div class="site-container mx-auto max-w-6xl gap-8">
    <!-- Hero text -->
    <div class="text-center mb-12">
      <h1
        class="from-base-900 to-base-600/90 dark:from-base-100 dark:to-base-400/90 bg-gradient-to-r bg-clip-text pb-4 text-5xl font-medium text-transparent md:text-6xl"
        data-mos="fade-up"
        data-mos-anchor="#plumber-hero"
      >
        Trust Policy Manager <br/> for <span class="text-primary-500">GitLab CI/CD</span>
      </h1>
      <p
        class="description mx-auto mt-4 max-w-2xl"
        data-mos="fade-up"
        data-mos-delay="0.2"
        data-mos-anchor="#plumber-hero"
      >
        Analyze your GitLab CI/CD pipelines for security and compliance issues. 
        Scan for mutable image tags, untrusted registries, and branch protection compliance.
      </p>
      
      <!-- CTA Buttons -->
      <div class="mx-auto mt-8 flex max-w-md flex-col justify-center gap-4 px-4 sm:flex-row" data-mos="fade-up" data-mos-delay="0.4" data-mos-anchor="#plumber-hero">
        <Button
          variant="primary"
          href="https://github.com/getplumber/plumber"
          target="_blank"
          rel="noopener noreferrer"
        >
          View on GitHub
        </Button>
        <Button
          variant="outline"
          href="/docs/cli/"
          arrow="right"
        >
          CLI Reference
        </Button>
      </div>
    </div>

    <!-- Code Toggle Section -->
    <div
      class="from-primary-400 to-base-300/70 after:bg-base-100/30 dark:from-primary-500 dark:to-base-300/50 dark:after:bg-base-800/50 relative mt-8 overflow-clip rounded-2xl bg-gradient-to-b to-40% p-1 after:absolute after:inset-[1px] after:rounded-[calc(1rem-1px)] md:p-2"
      data-mos="fade-up"
      data-mos-delay="0.6"
      data-mos-anchor="#plumber-hero"
    >
      <div
        class="code-toggle dark border-base-600/60 relative z-10 w-full overflow-clip rounded-xl border bg-[var(--astro-code-background)] md:rounded-lg"
      >
        <div class="tabs border-base-600/60 flex items-center justify-between gap-2 overflow-x-auto border-b p-3">
          <div class="flex gap-2">
            {
              codeToggleData.map((codeToggle, idx) => (
                <button
                  id={`plumber-code-toggle-${idx}`}
                  class="code-toggle__tab border-base-600/60 text-base-300 hover:border-primary-400 flex items-center rounded-md border px-2 py-1 transition duration-300"
                  data-tab={idx}
                  aria-expanded="false"
                  aria-haspopup="true"
                  aria-controls={`plumber-code-content-${idx}`}
                >
                  {codeToggle.icon && (
                    <Icon
                      name={codeToggle.icon}
                      class="code-toggle__icon mr-1 size-4"
                      aria-hidden="true"
                    />
                  )}
                  <span>{codeToggle.language}</span>
                </button>
              ))
            }
          </div>
          {/* Copy button */}
          <button
            class="code-copy-btn flex items-center gap-2 rounded-md border border-base-600/60 bg-base-800/50 px-3 py-1.5 text-xs text-base-300 transition-colors hover:border-primary-400 hover:bg-base-700/50 hover:text-base-100"
            data-copy-target="active"
            aria-label="Copy code"
          >
            <Icon
              name="tabler/copy"
              class="size-4"
              aria-hidden="true"
            />
            <span class="copy-text">Copy</span>
          </button>
        </div>
        <div class="code-window h-80 bg-[var(--astro-code-background)] relative">
          <div class="relative z-10 h-full overflow-auto">
            {
              codeToggleData.map((codeToggle, idx) => (
                <div
                  id={`plumber-code-content-${idx}`}
                  class:list={[
                    "code-toggle__content absolute inset-x-0 z-10 h-full max-w-none p-4",
                    "slide-in-from-bottom-1 fade-in-0 animate-in hidden transition-all duration-500 will-change-transform",
                  ]}
                  data-tab={idx}
                  aria-labelledby={`plumber-code-toggle-${idx}`}
                >
                  {/* render the code HTML */}
                  <codeToggle.code />
                </div>
              ))
            }
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  function plumberCodeToggleSetup() {
    const tabs = document.querySelectorAll("#plumber-hero .code-toggle__tab");
    const contents = document.querySelectorAll("#plumber-hero .code-toggle__content") as NodeListOf<HTMLElement>;

    if (!tabs.length || !contents.length) return;

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        // if tab has class "active", return
        if (tab.classList.contains("active")) return;

        //@ts-ignore
        const newContent = contents[parseInt(tab.getAttribute("data-tab"))];

        // remove active class from currently active tab
        tabs.forEach((t) => {
          if (t.classList.contains("active")) {
            // turn off currently active tab
            t.classList.remove("active");
            t.setAttribute("aria-expanded", "false");

            // hide currently active content
            //@ts-ignore
            const oldContent = contents[parseInt(t.getAttribute("data-tab"))];
            oldContent.classList.add("hidden");
          }
        });

        // add active class to clicked tab
        tab.classList.add("active");
        tab.setAttribute("aria-expanded", "true");

        // show new code content
        newContent.classList.remove("hidden");
      });
    });

    // Set default active tab (GitLab CI/CD should be first)
    if (tabs.length > 0) {
      tabs[0].classList.add("active");
      tabs[0].setAttribute("aria-expanded", "true");
      contents[0].classList.remove("hidden");
    }
  }

  function extractCodeFromElement(element: HTMLElement): string {
    // Find all <pre><code> blocks and extract their text content
    const codeBlocks = element.querySelectorAll("pre code");
    const codeTexts: string[] = [];
    
    codeBlocks.forEach((codeBlock) => {
      const text = codeBlock.textContent || "";
      if (text.trim()) {
        codeTexts.push(text.trim());
      }
    });
    
    return codeTexts.join("\n\n");
  }

  function setupCopyButtons() {
    const copyButton = document.querySelector("#plumber-hero .code-copy-btn");
    if (!copyButton) return;
    
    copyButton.addEventListener("click", async () => {
      // Find the currently active code content
      const activeContent = document.querySelector("#plumber-hero .code-toggle__content:not(.hidden)");
      if (!activeContent || !(activeContent instanceof HTMLElement)) return;
      
      // Extract code from the rendered HTML
      const rawCode = extractCodeFromElement(activeContent);
      
      if (!rawCode) return;
      
      try {
        await navigator.clipboard.writeText(rawCode);
        
        // Update button text
        const copyText = copyButton.querySelector(".copy-text");
        if (copyText) {
          const originalText = copyText.textContent;
          copyText.textContent = "Copied!";
          
          setTimeout(() => {
            copyText.textContent = originalText;
          }, 2000);
        }
      } catch (err) {
        console.error("Failed to copy code:", err);
      }
    });
  }

  // runs on initial page load
  plumberCodeToggleSetup();
  setupCopyButtons();

  // runs on view transitions navigation
  document.addEventListener("astro:after-swap", () => {
    plumberCodeToggleSetup();
    setupCopyButtons();
  });
</script>

<style>
  @import "tailwindcss/theme" theme(reference);
  @import "@/styles/tailwind-theme.css" theme(reference);

  #plumber-hero .code-toggle__tab.active {
    @apply border-primary-400 text-base-100 before:opacity-100;
  }

  #plumber-hero .code-copy-btn {
    backdrop-filter: blur(8px);
  }

  #plumber-hero .code-copy-btn:hover {
    @apply border-primary-400/80 bg-base-700/70;
  }
</style>
