---
/**
 * Analytics consent banner for GDPR/CNIL (France) compliance.
 * Uses same cookie as main site; if user accepts here, main site will load Plausible when visited.
 */

import Button from "@/docs/components/button/Button.astro";
import { getLocaleFromUrl } from "@/docs/js/localeUtils";

const currLocale = getLocaleFromUrl(Astro.url);
---

<div id="accept-banner" class="fixed inset-x-6 bottom-6 z-50 hidden justify-center">
  <div
    class="bg-muted flex flex-wrap items-center justify-center gap-x-6 gap-y-4 rounded-xl border p-4"
  >
    <div class="docs-markdown-content text-center">
      <p class="text-sm lg:text-base">
        We use anonymous analytics to understand how the site is used. You can accept or refuse. See our
        <a href={"/privacy-policy"} aria-label="Privacy Policy" class="">Privacy Policy</a>
        for details.
      </p>
    </div>
    <div class="mx-auto flex gap-2">
      <Button variant="secondary" type="button" class="min-w-0 px-6 py-2">Accept</Button>
      <Button variant="ghost" type="button" class="min-w-0 px-6 py-2">Refuse</Button>
    </div>
  </div>
</div>

<script>
  function getCookieConsent() {
    try {
      const m = document.cookie.match(/cookie-consent=([^;]+)/);
      return m ? m[1] : null;
    } catch (_) {
      return null;
    }
  }

  function cookieConsentSetup() {
    const cookieBanner = document.getElementById("accept-banner");
    const acceptButton = document.querySelector("#accept-banner button:first-of-type");
    const declineButton = document.querySelector("#accept-banner button:last-of-type");

    function setConsentCookie(value, maxAgeDays) {
      const d = new Date();
      d.setTime(d.getTime() + maxAgeDays * 24 * 60 * 60 * 1000);
      document.cookie = "cookie-consent=" + value + "; path=/; expires=" + d.toUTCString() + "; SameSite=Lax";
    }

    const cookieConsent = getCookieConsent();
    if (cookieConsent !== "accept" && cookieConsent !== "decline") {
      cookieBanner?.classList.add("flex");
      cookieBanner?.classList.remove("hidden");
    }

    acceptButton?.addEventListener("click", () => {
      cookieBanner?.classList.add("hidden");
      setConsentCookie("accept", 365);
      const enable = (window as Record<string, unknown>)["enablePlausibleAnalytics"];
      if (typeof enable === "function") (enable as () => void)();
    });

    declineButton?.addEventListener("click", () => {
      cookieBanner?.classList.add("hidden");
      setConsentCookie("decline", 365);
    });
  }

  cookieConsentSetup();
  document.addEventListener("astro:after-swap", cookieConsentSetup);
</script>
