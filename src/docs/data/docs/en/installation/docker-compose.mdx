---
title: Docker compose
description: This page describes how to set up a self-managed instance of Plumber using Docker-compose.
sidebar:
  order: 2
  label: ‚û°Ô∏è Docker Compose
---

This page describes how to set up a self-managed instance of Plumber using
**Docker-compose**.

## üíª Requirements

- **GitLab instance version >=17.7**
- The system requires a Linux server. It runs in üê≥ Docker containers using a
   docker-compose configuration. Specifications:
   - OS: Ubuntu or Debian
   - Hardware
      - CPU x86_64/amd64 with at least 2 cores
      - 4 GB RAM
      - 250 GB of storage for Plumber
   - Network
      - Users must be able to reach the Plumber server on TCP ports 80 and 443
      - The Plumber server must be able to access internet
      - The Plumber server must be able to communicate with GitLab instance
      - The installation process requires write access to the DNS Zone
         to set up Plumber domain
   - Installed software
      - [Git](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git)
      - [Docker](https://docs.docker.com/engine/install/)
      - Note: both compose plugin (`docker compose`) and `docker-compose` CLI are
         working. The first one is installed by default with `Docker`

## üîê Choose your certificate method

<Tabs defaultValue="auto" syncKey="cert-method">
  <TabsList>
    <TabsTrigger value="auto">Auto (Let's Encrypt)</TabsTrigger>
    <TabsTrigger value="custom">Custom certificates</TabsTrigger>
  </TabsList>
  <TabsContent value="auto">
    **Recommended for most users.** Certificates are automatically generated and renewed using Let's Encrypt.

    Requirements:
    - Server must be reachable from the internet on ports 80 and 443
  </TabsContent>
  <TabsContent value="custom">
    **For air-gapped environments or custom PKI.** You provide your own SSL certificates.

    Use this if:
    - Your server is not reachable from the internet
    - You need to use certificates from your own Certificate Authority
  </TabsContent>
</Tabs>

## üõ†Ô∏è Installation

<Steps>

1. ### üì• Setup your environment

   Clone the repository on your server
   ```sh
   git clone https://github.com/getplumber/platform.git plumber-platform
   cd plumber-platform
   ```

   Create your configuration file
   ```sh
   cp .env.example .env
   ```

2. ### üìã Configure Organization

   **In your `.env` file:**

   - **If you want to connect Plumber to a specific GitLab group only**: add the path of the group in `ORGANIZATION` variable (to run the onboarding, you must be at least **Maintainer in this group**)
      ```bash title=".env"
      ORGANIZATION="<group-path>"
      ```

   - **If you want to connect Plumber to the whole GitLab instance**: let the `ORGANIZATION` variable empty (to run the onboarding, you must be a **GitLab instance Admin**)
      ```bash title=".env"
      ORGANIZATION=""
      ```

3. ### üìÑ Configure Domain name

   Edit the `.env` file by updating value of `DOMAIN_NAME` and `JOBS_GITLAB_URL` variables

   ```bash title=".env"
   DOMAIN_NAME="<your_plumber_domain>"
   JOBS_GITLAB_URL="https://<url_of_your_gitlab_instance>"
   ```

   ```bash title="Example"
   DOMAIN_NAME="plumber.mydomain.com"
   JOBS_GITLAB_URL="https://gitlab.mydomain.com"
   ```

   Create DNS record

   <Steps>
   1. Name: `<your_plumber_domain>`
   2. Type: `A`
   3. Content: `<your-server-public-ip>`
   </Steps>

4. ### ü¶ä Configure GitLab OIDC

   Plumber uses GitLab as an OAuth2 provider to authenticate users. Let's see how
   to connect it to your GitLab instance.

   **Create an application**

   Choose a group on your GitLab instance to create an application. It can be any
   group. Open the chosen group in GitLab interface and navigate through
   `Settings > Applications`:

   ![Profile_Menu](./img/profile_menu_gitlab.png)

   Then, create an application with the following information :

   <Steps>
   1. Name: `Plumber self-managed`
   2. Redirect URI : `https://<your_plumber_domain>/api/auth/gitlab/callback`
   3. Confidential: `true` (let the box checked)
   4. Scopes: `api`
   </Steps>

   Click on `Save Application` and you should see the following screen:

   ![Application](./img/application_created_gitlab.png)

   **Update the configuration**

   In `.env` file:

   Copy/paste the `Application ID` and the `Secret` from the application you
   just created
   ```bash title=".env"
   GITLAB_OAUTH2_CLIENT_ID="<application-id>"
   GITLAB_OAUTH2_CLIENT_SECRET="<application-secret>"
   ```

5. ### üîê Generate secrets

   Generate random secrets for all components:

   ```bash
   sed -i."" "s/REPLACE_ME_BY_SECRET_KEY/$(openssl rand -hex 32)/g" .env
   sed -i."" "s/REPLACE_ME_BY_JOBS_DB_PASSWORD/$(openssl rand -hex 16)/g" .env
   sed -i."" "s/REPLACE_ME_BY_JOBS_REDIS_PASSWORD/$(openssl rand -hex 16)/g" .env
   ```

6. ### üìÑ Configure certificate

   <Tabs defaultValue="auto" syncKey="cert-method">
     <TabsList>
       <TabsTrigger value="auto">Auto (Let's Encrypt)</TabsTrigger>
       <TabsTrigger value="custom">Custom certificates</TabsTrigger>
     </TabsList>
     <TabsContent value="auto">
       No action needed! Certificates will be automatically generated at first launch.
     </TabsContent>
     <TabsContent value="custom">
       **Option A: Generate with certbot**

       ```bash
       certbot certonly --manual --preferred-challenges dns -d <your_plumber_domain>
       # Add DNS entry to solve DNS challenge
       ```

       <Aside variant="info">
       If you generated your certificates using certbot, they are located in `/etc/letsencrypt/live/`
       </Aside>

       **Option B: Use existing certificates**

       Copy the fullchain and private key to the Traefik certs folder:

       ```bash
       cp /path/to/your/fullchain.pem .docker/traefik/certs/plumber_fullchain.pem
       cp /path/to/your/privkey.pem .docker/traefik/certs/plumber_privkey.pem
       ```
     </TabsContent>
   </Tabs>

7. ### üìã (Optional) Add your custom CA

   If your GitLab instance (or Plumber with custom certificates) uses a TLS certificate signed with your own Certificate Authority (CA):

   <Steps>
   1. Add the CA certificate file in `.docker/ca-certificates`
   </Steps>

8. ### üöÄ Launch the application

   <Tabs defaultValue="auto" syncKey="cert-method">
     <TabsList>
       <TabsTrigger value="auto">Auto (Let's Encrypt)</TabsTrigger>
       <TabsTrigger value="custom">Custom certificates</TabsTrigger>
     </TabsList>
     <TabsContent value="auto">

       ```bash
       docker compose up -d
       ```

     </TabsContent>
     <TabsContent value="custom">

       ```bash
       docker compose -f compose.custom_certs.yml up -d
       ```

     </TabsContent>
   </Tabs>


</Steps>

## ‚è´ Update

Follow these steps to update your self-managed instance to a new version:

<Steps>

1. Navigate to the location of your
   [`platform`](https://github.com/getplumber/platform/) git repository

2. Update it
   ```sh
   git pull
   ```

3. Open the `.env.example` file and copy the values of  `FRONTEND_IMAGE_TAG`
   and `BACKEND_IMAGE_TAG` variables

4. Edit the `.env` file by updating values of `FRONTEND_IMAGE_TAG` and
   `BACKEND_IMAGE_TAG` variables with the values previously copied
   ```sh title=".env"
   FRONTEND_IMAGE_TAG="<new frontend version>"
   BACKEND_IMAGE_TAG="<new backend version>"
   ```

5. Restart your containers

   <Tabs defaultValue="auto" syncKey="cert-method">
     <TabsList>
       <TabsTrigger value="auto">Auto (Let's Encrypt)</TabsTrigger>
       <TabsTrigger value="custom">Custom certificates</TabsTrigger>
     </TabsList>
     <TabsContent value="auto">

       ```sh
       docker compose up -d
       ```

     </TabsContent>
     <TabsContent value="custom">

       ```sh
       docker compose -f compose.custom_certs.yml up -d
       ```

     </TabsContent>
   </Tabs>

6. You have successfully updated Plumber on your server üéâ

</Steps>

## üîÑ Backup and restore

Data required to fully backup and restore a Plumber system are the following:

- Configuration file: `.env`
- Databases:
  - PostgreSQL database of Jobs service
- Files data:
  - File storing data about certificate for Traefik service

All these data can be easily backup and restored using 2 scripts from the
installation git repository:

- `scripts/backup.sh`
- `scripts/restore.sh`

### üíΩ Backup

To backup the system, go to your installation git repository and run the
following command:

```bash
./scripts/backup.sh 13
```

The script will create a `backups` directory and create a backup archive inside
it prefixed with the date (`backup_plumber-$DATE`)

<Aside variant="info">
You can use a cron job to perform regular backups.
Here is a cron job that launch a backup every day at 2am:
```bash
0 2 * * * /plumber-platform/scripts/backup.sh 13
```
It can be added to your crontab with the command `crontab -e`. Check more
information about cron jobs
[here](https://help.ubuntu.com/community/CronHowto).
</Aside>

### üõ≥Ô∏è Restore

To restore a backup from scratch on a new system, follow this process:

<Steps>

1. Be sure that your new system is compliant with
   [requirements](#-requirements)

2. Copy the backup file on your new server

3. Clone the installation repository
   ```bash
   git clone https://github.com/getplumber/platform.git plumber-platform
   cd plumber-platform
   ```

4. If the IP address of your server changed from your previous installation,
   update your DNS records. See [section
   2](#-domain-name) of domain configuration

5. Launch the restore script
   ```bash
   ./scripts/restore.sh 13 <path_to_your_backup_file>
   ```

</Steps>