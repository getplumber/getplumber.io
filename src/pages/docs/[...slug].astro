---
import { getCollection, render } from "astro:content";

import CustomH1 from "@/docs/components/markdown-overrides/CustomH1.astro";
import CustomH1Copy from "@/docs/components/markdown-overrides/CustomH1Copy.astro";
import CustomH2 from "@/docs/components/markdown-overrides/CustomH2.astro";
import CustomH2Copy from "@/docs/components/markdown-overrides/CustomH2Copy.astro";
import CustomH3 from "@/docs/components/markdown-overrides/CustomH3.astro";
import CustomH3Copy from "@/docs/components/markdown-overrides/CustomH3Copy.astro";
import CustomH4 from "@/docs/components/markdown-overrides/CustomH4.astro";
import CustomH4Copy from "@/docs/components/markdown-overrides/CustomH4Copy.astro";
import CustomH5 from "@/docs/components/markdown-overrides/CustomH5.astro";
import CustomH5Copy from "@/docs/components/markdown-overrides/CustomH5Copy.astro";
import CustomH6 from "@/docs/components/markdown-overrides/CustomH6.astro";
import CustomH6Copy from "@/docs/components/markdown-overrides/CustomH6Copy.astro";
import ExternalLink from "@/docs/components/markdown-overrides/ExternalLink.astro";
import { defaultLocale, siteSettings } from "@/docs/config/siteSettings.json";
import { docsRoute } from "@/docs/js/docsUtils";
import { filterCollectionByLanguage } from "@/docs/js/localeUtils";
import { getLocalizedRoute, getTranslatedData } from "@/docs/js/translationUtils";
import DocsLayout from "@/docs/layouts/DocsLayout.astro";

export async function getStaticPaths() {
  const docs = await getCollection("docs", ({ data }) => {
    // filter out draft pages
    return data.draft !== true;
  });

  console.log("[getStaticPaths] Total docs found:", docs.length);
  console.log("[getStaticPaths] Sample doc IDs:", docs.slice(0, 5).map(d => d.id));

  // get rid of pages from other languages and remove locale from slug
  const filteredDocs = filterCollectionByLanguage(docs, defaultLocale);

  console.log("[getStaticPaths] Filtered docs count:", filteredDocs.length);
  console.log("[getStaticPaths] Filtered doc IDs:", filteredDocs.map(d => d.id));
  
  // Log sample doc data to see what properties they have
  if (filteredDocs.length > 0) {
    console.log("[getStaticPaths] Sample doc data:", {
      id: filteredDocs[0].id,
      hasSection: 'section' in filteredDocs[0].data,
      section: filteredDocs[0].data.section,
      dataKeys: Object.keys(filteredDocs[0].data)
    });
  }

  const sidebarData = getTranslatedData("sidebarNavData", defaultLocale);
  const documentationTabs = sidebarData.tabs;

  console.log("[getStaticPaths] Documentation tabs:", documentationTabs?.length || 0);
  if (documentationTabs && documentationTabs.length > 0) {
    console.log("[getStaticPaths] Tab IDs:", documentationTabs.map(t => t.id));
    documentationTabs.forEach(tab => {
      console.log(`[getStaticPaths] Tab "${tab.id}" sections:`, tab.sections?.map(s => s.id) || []);
    });
  }

  // Create paths for each docs section
  const paths: any[] = [];

  // Helper to generate paths for a doc (handles index files)
  const generatePathsForDoc = (doc: any, sectionId: string) => {
    const docId = doc.id as string;
    const pathsForDoc: any[] = [];

    // Always create the path with the full doc.id
    pathsForDoc.push({
      params: { slug: docId },
      props: { doc, sectionId },
    });

    // If the doc.id ends with "/index", also create a path without "/index"
    // e.g., "getting-started/index" -> also create path for "getting-started"
    if (docId.endsWith("/index")) {
      const slugWithoutIndex = docId.replace(/\/index$/, "");
      pathsForDoc.push({
        params: { slug: slugWithoutIndex },
        props: { doc, sectionId },
      });
      console.log(`[getStaticPaths] Created paths for ${docId}: ["${docId}", "${slugWithoutIndex}"]`);
    } else {
      console.log(`[getStaticPaths] Created path for ${docId}: ["${docId}"]`);
    }

    return pathsForDoc;
  };

  // If documentation tabs are defined, use them to generate paths for each section
  if (documentationTabs && documentationTabs.length > 0) {
    // Collect all section IDs from all tabs
    const allSectionIds = new Set<string>();
    documentationTabs.forEach(tab => {
      tab.sections?.forEach(section => {
        allSectionIds.add(section.id);
      });
    });

    console.log("[getStaticPaths] All section IDs from tabs:", Array.from(allSectionIds));

    for (const tab of documentationTabs) {
      if (!tab.sections || tab.sections.length === 0) continue;
      
      for (const section of tab.sections) {
        // Match docs to sections based on the first part of their ID (folder name)
        // e.g., "getting-started/index" matches section "getting-started"
        const sectionDocs = filteredDocs.filter((doc) => {
          const docId = doc.id as string;
          const firstSegment = docId.split("/")[0];
          return firstSegment === section.id;
        });

        console.log(`[getStaticPaths] Section "${section.id}" (tab: "${tab.id}") has ${sectionDocs.length} docs`);
        if (sectionDocs.length > 0) {
          console.log(`[getStaticPaths] Section "${section.id}" doc IDs:`, sectionDocs.map(d => d.id));
        }

        // Generate paths for this section
        const sectionPaths = sectionDocs.flatMap((doc) => generatePathsForDoc(doc, tab.id));
        paths.push(...sectionPaths);
      }
    }
    
    // If no paths were generated, fall back to generating all docs
    if (paths.length === 0) {
      console.log("[getStaticPaths] No paths generated from tabs, using fallback");
      const defaultPaths = filteredDocs.flatMap((doc) => generatePathsForDoc(doc, "main"));
      paths.push(...defaultPaths);
    }
  } else {
    // Fallback to original behavior if no tabs are configured
    console.log("[getStaticPaths] No tabs configured, using fallback");
    const defaultPaths = filteredDocs.flatMap((doc) => generatePathsForDoc(doc, "main"));
    paths.push(...defaultPaths);
  }

  console.log("[getStaticPaths] Total paths generated:", paths.length);
  console.log("[getStaticPaths] Sample paths:", paths.slice(0, 10).map(p => p.params.slug));

  return paths;
}

const { doc, sectionId = "main" } = Astro.props;
const { Content, headings } = await render(doc);
---

<DocsLayout doc={doc} headings={headings} sectionId={sectionId}>
  {
    siteSettings.copyLinkButtons === false ? (
      <Content
        components={{
          a: ExternalLink,
          h1: CustomH1,
          h2: CustomH2,
          h3: CustomH3,
          h4: CustomH4,
          h5: CustomH5,
          h6: CustomH6,
        }}
      />
    ) : (
      <Content
        components={{
          a: ExternalLink,
          h1: CustomH1Copy,
          h2: CustomH2Copy,
          h3: CustomH3Copy,
          h4: CustomH4Copy,
          h5: CustomH5Copy,
          h6: CustomH6Copy,
        }}
      />
    )
  }
</DocsLayout>