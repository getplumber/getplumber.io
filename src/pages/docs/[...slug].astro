---
import { getCollection, render } from "astro:content";

import CustomH1 from "@/docs/components/markdown-overrides/CustomH1.astro";
import CustomH1Copy from "@/docs/components/markdown-overrides/CustomH1Copy.astro";
import CustomH2 from "@/docs/components/markdown-overrides/CustomH2.astro";
import CustomH2Copy from "@/docs/components/markdown-overrides/CustomH2Copy.astro";
import CustomH3 from "@/docs/components/markdown-overrides/CustomH3.astro";
import CustomH3Copy from "@/docs/components/markdown-overrides/CustomH3Copy.astro";
import CustomH4 from "@/docs/components/markdown-overrides/CustomH4.astro";
import CustomH4Copy from "@/docs/components/markdown-overrides/CustomH4Copy.astro";
import CustomH5 from "@/docs/components/markdown-overrides/CustomH5.astro";
import CustomH5Copy from "@/docs/components/markdown-overrides/CustomH5Copy.astro";
import CustomH6 from "@/docs/components/markdown-overrides/CustomH6.astro";
import CustomH6Copy from "@/docs/components/markdown-overrides/CustomH6Copy.astro";
import ExternalLink from "@/docs/components/markdown-overrides/ExternalLink.astro";
import { defaultLocale, siteSettings } from "@/docs/config/siteSettings.json";
import { docsRoute } from "@/docs/js/docsUtils";
import { filterCollectionByLanguage } from "@/docs/js/localeUtils";
import { getLocalizedRoute, getTranslatedData } from "@/docs/js/translationUtils";
import DocsLayout from "@/docs/layouts/DocsLayout.astro";

export async function getStaticPaths() {
  const docs = await getCollection("docs", ({ data }) => {
    // filter out draft pages
    return data.draft !== true;
  });

  // get rid of pages from other languages and remove locale from slug
  const filteredDocs = filterCollectionByLanguage(docs, defaultLocale);

  const sidebarData = getTranslatedData("sidebarNavData", defaultLocale);
  const documentationTabs = sidebarData.tabs;

  // Create paths for each docs section
  const paths: any[] = [];

  // Helper to generate paths for a doc (handles index files)
  const generatePathsForDoc = (doc: any, sectionId: string) => {
    const docId = doc.id as string;
    const pathsForDoc: any[] = [];

    // Always create the path with the full doc.id
    pathsForDoc.push({
      params: { slug: docId },
      props: { doc, sectionId },
    });

    // If the doc.id ends with "/index", also create a path without "/index"
    // e.g., "getting-started/index" -> also create path for "getting-started"
    if (docId.endsWith("/index")) {
      const slugWithoutIndex = docId.replace(/\/index$/, "");
      pathsForDoc.push({
        params: { slug: slugWithoutIndex },
        props: { doc, sectionId },
      });
    }

    return pathsForDoc;
  };

  // If documentation tabs are defined, use them to generate paths for each section
  if (documentationTabs && documentationTabs.length > 0) {
    for (const tab of documentationTabs) {
      // Get sections for this tab
      const tabSections = tab.sections || [];
      const tabSectionIds = new Set(tabSections.map((s) => s.id));

      // Get all docs for this tab - match by folder structure (first segment of doc.id)
      const tabDocs = filteredDocs.filter((doc) => {
        const firstSegment = doc.id.split("/")[0];
        return tabSectionIds.has(firstSegment);
      });

      // Generate paths for this tab's docs
      const tabPaths = tabDocs.flatMap((doc) => generatePathsForDoc(doc, tab.id));
      paths.push(...tabPaths);
    }

    // If no paths were generated, fall back to generating all docs
    if (paths.length === 0) {
      const defaultPaths = filteredDocs.flatMap((doc) => generatePathsForDoc(doc, "main"));
      paths.push(...defaultPaths);
    }
  } else {
    // Fallback to original behavior if no tabs are configured
    const defaultPaths = filteredDocs.flatMap((doc) => generatePathsForDoc(doc, "main"));
    paths.push(...defaultPaths);
  }

  return paths;
}

const { doc, sectionId = "main" } = Astro.props;
const { Content, headings } = await render(doc);
---

<DocsLayout doc={doc} headings={headings} sectionId={sectionId}>
  {
    siteSettings.copyLinkButtons === false ? (
      <Content
        components={{
          a: ExternalLink,
          h1: CustomH1,
          h2: CustomH2,
          h3: CustomH3,
          h4: CustomH4,
          h5: CustomH5,
          h6: CustomH6,
        }}
      />
    ) : (
      <Content
        components={{
          a: ExternalLink,
          h1: CustomH1Copy,
          h2: CustomH2Copy,
          h3: CustomH3Copy,
          h4: CustomH4Copy,
          h5: CustomH5Copy,
          h6: CustomH6Copy,
        }}
      />
    )
  }
</DocsLayout>
